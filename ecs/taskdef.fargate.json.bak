{
  "family": "cal-onboarding-api-demo",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "512",
  "memory": "1024",
  "executionRoleArn": "arn:aws:iam::104013952213:role/ecsTaskExecutionRole",
  "taskRoleArn": "arn:aws:iam::104013952213:role/cal-onboarding-task-role",
  "containerDefinitions": [
    {
      "name": "onboarding-api",
        "image": "104013952213.dkr.ecr.us-west-2.amazonaws.com/cal-onboarding-api:production",
      "essential": true,
      "portMappings": [{ "containerPort": 8000, "hostPort": 8000 }],
      "environment": [
        { "name": "OTEL_EXPORTER_OTLP_ENDPOINT", "value": "http://127.0.0.1:4317" },
        { "name": "OTEL_EXPORTER_OTLP_PROTOCOL", "value": "grpc" },
        { "name": "OTEL_LOGS_EXPORTER", "value": "otlp" },
        { "name": "OTEL_RESOURCE_ATTRIBUTES", "value": "service.namespace=onboarding,service.name=onboarding-api,service.version=1.0.0,deployment.environment=production,owner=cal" }
      ],
      "dependsOn": [{ "containerName": "otel-collector", "condition": "START" }],
      "logConfiguration": { 
        "logDriver": "awslogs", 
        "options": { 
          "awslogs-group": "/ecs/cal-onboarding-api", 
          "awslogs-region": "us-west-2", 
          "awslogs-stream-prefix": "ecs" 
        } 
      }
    },
    {
      "name": "otel-collector",
        "image": "104013952213.dkr.ecr.us-west-2.amazonaws.com/cal-otel-collector:apm",
      "essential": true,
      "environment": [
        { "name": "CORALOGIX_DOMAIN", "value": "us2.coralogix.com" }
      ],
      "secrets": [
        { "name": "CORALOGIX_PRIVATE_KEY", "valueFrom": "arn:aws:secretsmanager:us-west-2:104013952213:secret:cal-coralogix-api-key" }
      ],
      "command": ["--config=/etc/otelcol/config.yaml"],
      "portMappings": [
        { "containerPort": 4317, "protocol": "tcp" },
        { "containerPort": 4318, "protocol": "tcp" }
      ],
      "logConfiguration": { 
        "logDriver": "awslogs", 
        "options": { 
          "awslogs-group": "/ecs/cal-otel-collector", 
          "awslogs-region": "us-west-2", 
          "awslogs-stream-prefix": "ecs" 
        } 
      }
    }
  ]
}
